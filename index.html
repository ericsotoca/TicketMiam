
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TicketMiam - 100% Gratuit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; margin: 0; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .nutri-a { background-color: #008b4c; } .nutri-b { background-color: #80c11e; }
        .nutri-c { background-color: #fecb02; } .nutri-d { background-color: #ee8100; }
        .nutri-e { background-color: #e63e11; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        #root:empty::before {
            content: "TicketMiam...";
            display: flex; justify-content: center; align-items: center; height: 100vh;
            color: #10b981; font-weight: 900; font-size: 1.5rem;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.41.0",
    "react": "https://esm.sh/react@^19.2.4",
    "recharts": "https://esm.sh/recharts@^3.7.0",
    "react/": "https://esm.sh/react@^19.2.4/",
    "tesseract.js": "https://esm.sh/tesseract.js@^7.0.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { h, render } from 'https://esm.sh/preact@10.23.1';
        import { useState, useEffect, useMemo } from 'https://esm.sh/preact@10.23.1/hooks';
        import htm from 'https://esm.sh/htm@3.1.1';
        import { createWorker } from 'https://esm.sh/tesseract.js@5.1.0';
        import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'https://esm.sh/recharts@2.12.7?external=preact/compat';

        const html = htm.bind(h);

        // --- MOTEUR OCR ET DONNÉES ---
        async function searchOFF(query) {
            const cleanQuery = query.replace(/[0-9]/g, '').trim();
            if (cleanQuery.length < 3) return null;
            try {
                const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(cleanQuery)}&search_simple=1&action=process&json=1&page_size=1`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.products && data.products.length > 0) {
                    const p = data.products[0];
                    return {
                        name: p.product_name_fr || p.product_name,
                        score: (p.nutrition_grades || 'C').toUpperCase(),
                        nova: p.nova_group === 4,
                        kcal: Math.round(p.nutriments['energy-kcal_100g'] || 0),
                        p: p.nutriments.proteins_100g || 0,
                        c: p.nutriments.carbohydrates_100g || 0,
                        l: p.nutriments.fat_100g || 0
                    };
                }
            } catch (e) { return null; }
            return null;
        }

        // --- COMPOSANTS UI ---
        const Badge = ({ score, size = 'md' }) => {
            const colors = { A: 'nutri-a', B: 'nutri-b', C: 'nutri-c', D: 'nutri-d', E: 'nutri-e' };
            const sizes = { sm: 'w-6 h-6 text-[10px]', md: 'w-10 h-10 text-lg', lg: 'w-16 h-16 text-3xl' };
            return html`<div class="${colors[score] || 'bg-slate-200'} text-white ${sizes[size]} rounded-lg flex items-center justify-center font-black shadow-sm">${score}</div>`;
        };

        const App = () => {
            const [view, setView] = useState('home');
            const [loading, setLoading] = useState(false);
            const [progress, setProgress] = useState("");
            const [result, setResult] = useState(null);
            const [history, setHistory] = useState([]);

            useEffect(() => {
                const saved = localStorage.getItem('tm_free_hist');
                if (saved) setHistory(JSON.parse(saved));
            }, []);

            const handleScan = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoading(true);
                setProgress("Initialisation...");

                try {
                    const worker = await createWorker('fra', 1, {
                        logger: m => { if (m.status === 'recognizing text') setProgress(`Lecture : ${Math.round(m.progress * 100)}%`); }
                    });
                    const { data: { lines } } = await worker.recognize(file);
                    await worker.terminate();

                    setProgress("Analyse nutritionnelle...");
                    const products = [];
                    // On prend les lignes qui ressemblent à des produits (pas les totaux)
                    const filteredLines = lines
                        .map(l => l.text.trim())
                        .filter(t => t.length > 5 && !/TOTAL|TVA|EURO|PRIX|MERCI|MAGASIN/i.test(t))
                        .slice(0, 12); // Limite pour la rapidité

                    for (const line of filteredLines) {
                        const product = await searchOFF(line);
                        if (product) products.push(product);
                    }

                    if (products.length === 0) throw new Error("Aucun produit reconnu.");

                    const scoreMap = { A: 4, B: 3, C: 2, D: 1, E: 0 };
                    const avg = products.reduce((acc, p) => acc + (scoreMap[p.score] || 2), 0) / products.length;
                    const global = avg >= 3.5 ? 'A' : avg >= 2.5 ? 'B' : avg >= 1.5 ? 'C' : avg >= 0.5 ? 'D' : 'E';

                    const newResult = {
                        id: Date.now(),
                        date: new Date().toLocaleDateString('fr-FR'),
                        global,
                        items: products,
                        totals: products.reduce((acc, p) => ({
                            p: acc.p + p.p, c: acc.c + p.c, l: acc.l + p.l
                        }), { p: 0, c: 0, l: 0 })
                    };

                    setResult(newResult);
                    const newHist = [newResult, ...history].slice(0, 10);
                    setHistory(newHist);
                    localStorage.setItem('tm_free_hist', JSON.stringify(newHist));
                    setView('result');
                } catch (err) {
                    alert(err.message || "Erreur lors du scan.");
                } finally { setLoading(false); setProgress(""); }
            };

            if (loading) return html`
                <div class="min-h-screen flex flex-col items-center justify-center p-10 bg-emerald-500 text-white animate-pop">
                    <div class="w-20 h-20 border-8 border-white/20 border-t-white animate-spin rounded-full mb-8"></div>
                    <h2 class="text-3xl font-black tracking-tighter">${progress}</h2>
                    <p class="mt-2 font-medium opacity-80">Traitement 100% local</p>
                </div>
            `;

            return html`
                <div class="max-w-md mx-auto min-h-screen p-6 pb-32">
                    ${view === 'home' ? html`
                        <div class="space-y-12 py-10 animate-pop">
                            <header class="text-center space-y-2">
                                <h1 class="text-5xl font-black tracking-tighter text-slate-900">TicketMiam</h1>
                                <p class="text-emerald-500 font-bold uppercase text-[10px] tracking-widest">Open Food Facts Inside</p>
                            </header>

                            <label class="flex flex-col items-center justify-center w-full h-80 border-4 border-emerald-500 border-dashed rounded-[3rem] bg-white shadow-2xl cursor-pointer hover:bg-emerald-50 transition-all active:scale-95">
                                <div class="w-20 h-20 bg-emerald-500 text-white rounded-full flex items-center justify-center shadow-lg mb-4">
                                    <i class="fas fa-camera text-3xl"></i>
                                </div>
                                <span class="font-black text-slate-800 text-xl">Scanner un ticket</span>
                                <input type="file" class="hidden" accept="image/*" capture="environment" onchange=${handleScan} />
                            </label>

                            ${history.length > 0 && html`
                                <div class="space-y-4">
                                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest px-2">Historique</h3>
                                    <div class="bg-white rounded-[2.5rem] divide-y divide-slate-50 overflow-hidden shadow-sm border border-slate-100">
                                        ${history.map(h => html`
                                            <div key=${h.id} onclick=${() => { setResult(h); setView('result'); }} class="flex items-center justify-between p-5 hover:bg-slate-50 cursor-pointer transition-colors">
                                                <div class="flex items-center space-x-4">
                                                    <${Badge} score=${h.global} size="sm" />
                                                    <span class="font-bold text-slate-700 text-sm">${h.date}</span>
                                                </div>
                                                <i class="fas fa-chevron-right text-slate-200"></i>
                                            </div>
                                        `)}
                                    </div>
                                </div>
                            `}
                        </div>
                    ` : html`
                        <div class="space-y-6 animate-pop">
                            <button onclick=${() => setView('home')} class="w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-slate-400"><i class="fas fa-arrow-left"></i></button>
                            
                            <section class="bg-white rounded-[3rem] p-10 shadow-2xl text-center space-y-6">
                                <p class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Score Global du Panier</p>
                                <div class="flex justify-center scale-150 py-4"><${Badge} score=${result.global} size="lg" /></div>
                                <h2 class="text-2xl font-black text-slate-900 leading-tight">Analyse terminée</h2>
                            </section>

                            <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100">
                                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Répartition Moyenne</h3>
                                <div class="h-48 flex items-center justify-center bg-slate-50 rounded-3xl text-slate-300 italic">
                                    Graphique local actif
                                </div>
                                <div class="flex justify-around mt-6 text-center">
                                    <div><p class="text-emerald-500 font-black text-xl">${Math.round(result.totals.p)}g</p><p class="text-[9px] uppercase font-bold text-slate-400">Prot</p></div>
                                    <div><p class="text-blue-500 font-black text-xl">${Math.round(result.totals.c)}g</p><p class="text-[9px] uppercase font-bold text-slate-400">Gluc</p></div>
                                    <div><p class="text-amber-500 font-black text-xl">${Math.round(result.totals.l)}g</p><p class="text-[9px] uppercase font-bold text-slate-400">Lip</p></div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <h3 class="text-xs font-black text-slate-800 uppercase tracking-widest px-4">Produits Identifiés</h3>
                                ${result.items.map((item, i) => html`
                                    <div key=${i} class="bg-white p-4 rounded-3xl flex items-center space-x-4 border border-slate-100 shadow-sm">
                                        <${Badge} score=${item.score} size="sm" />
                                        <div class="flex-1 min-w-0">
                                            <p class="font-bold text-slate-800 text-sm truncate uppercase">${item.name}</p>
                                            <div class="flex items-center space-x-2 mt-1">
                                                <span class="text-[9px] text-slate-400 font-black">${item.kcal} kcal/100g</span>
                                                ${item.nova && html`<span class="bg-red-50 text-red-500 text-[8px] px-2 py-0.5 rounded-full font-black">NOVA 4</span>`}
                                            </div>
                                        </div>
                                    </div>
                                `)}
                            </div>
                        </div>
                    `}

                    <nav class="fixed bottom-8 left-10 right-10 bg-white/90 backdrop-blur-xl px-10 py-5 flex justify-around items-center rounded-full shadow-2xl z-50">
                        <button onclick=${() => setView('home')} class="text-2xl ${view === 'home' ? 'text-emerald-500' : 'text-slate-300'}"><i class="fas fa-home"></i></button>
                        <label class="bg-emerald-500 w-16 h-16 rounded-full flex items-center justify-center text-white shadow-xl cursor-pointer transform -translate-y-10 active:scale-90 transition-all border-4 border-slate-50">
                            <i class="fas fa-plus text-2xl"></i>
                            <input type="file" class="hidden" accept="image/*" capture="environment" onchange=${handleScan} />
                        </label>
                        <button onclick=${() => { localStorage.clear(); location.reload(); }} class="text-2xl text-slate-300"><i class="fas fa-trash"></i></button>
                    </nav>
                </div>
            `;
        };

        render(html`<${App} />`, document.getElementById('root'));
    </script>
</body>
</html>
