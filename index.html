
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TicketMiam - Analyse Intelligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; margin: 0; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .nutri-a { background-color: #008b4c; } .nutri-b { background-color: #80c11e; }
        .nutri-c { background-color: #fecb02; } .nutri-d { background-color: #ee8100; }
        .nutri-e { background-color: #e63e11; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.41.0",
    "react": "https://esm.sh/react@^19.2.4",
    "recharts": "https://esm.sh/recharts@^3.7.0",
    "react/": "https://esm.sh/react@^19.2.4/",
    "tesseract.js": "https://esm.sh/tesseract.js@^7.0.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { h, render } from 'https://esm.sh/preact@10.23.1';
        import { useState, useEffect, useMemo } from 'https://esm.sh/preact@10.23.1/hooks';
        import htm from 'https://esm.sh/htm@3.1.1';
        import { GoogleGenAI, Type } from 'https://esm.sh/@google/genai@1.41.0';
        import { createWorker } from 'https://esm.sh/tesseract.js@5.1.0';
        import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'https://esm.sh/recharts@2.12.7?external=preact/compat';

        const html = htm.bind(h);

        const PRODUCT_SCHEMA = {
            type: Type.OBJECT,
            properties: {
                store: { type: Type.STRING },
                items: {
                    type: Type.ARRAY,
                    items: {
                        type: Type.OBJECT,
                        properties: {
                            name: { type: Type.STRING },
                            score: { type: Type.STRING },
                            nova4: { type: Type.BOOLEAN },
                            kcal: { type: Type.NUMBER },
                            p: { type: Type.NUMBER },
                            c: { type: Type.NUMBER },
                            l: { type: Type.NUMBER }
                        },
                        required: ["name", "score", "kcal", "p", "c", "l"]
                    }
                }
            },
            required: ["store", "items"]
        };

        // --- SERVICES ---
        async function analyzeWithGemini(base64) {
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            const prompt = `Analyse ce ticket. 1. Identifie le magasin. 2. Liste uniquement les articles alimentaires. 3. Pour chaque article, déduis intelligemment le Nutri-Score (A-E), si c'est ultra-transformé (NOVA4), et les calories/macros (p, c, l) pour 100g. Réponds en JSON.`;
            
            const response = await ai.models.generateContent({
                model: "gemini-3-flash-preview",
                contents: { parts: [{ inlineData: { mimeType: "image/jpeg", data: base64.split(",")[1] } }, { text: prompt }] },
                config: { responseMimeType: "application/json", responseSchema: PRODUCT_SCHEMA }
            });
            return JSON.parse(response.text);
        }

        const Badge = ({ score, size = 'md' }) => {
            const colors = { A: 'nutri-a', B: 'nutri-b', C: 'nutri-c', D: 'nutri-d', E: 'nutri-e' };
            const sizes = { sm: 'w-6 h-6 text-[10px]', md: 'w-10 h-10 text-lg', lg: 'w-16 h-16 text-3xl' };
            return html`<div class="${colors[score] || 'bg-slate-200'} text-white ${sizes[size]} rounded-lg flex items-center justify-center font-black shadow-sm">${score}</div>`;
        };

        const App = () => {
            const [view, setView] = useState('home');
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState("");
            const [data, setData] = useState(null);
            const [history, setHistory] = useState([]);

            useEffect(() => {
                const saved = localStorage.getItem('tm_v5_history');
                if (saved) setHistory(JSON.parse(saved));
            }, []);

            const onUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoading(true); setStatus("Analyse Intelligente...");
                
                try {
                    const reader = new FileReader();
                    const base64 = await new Promise(r => { reader.onload = () => r(reader.result); reader.readAsDataURL(file); });
                    
                    // On utilise Gemini par défaut pour la pertinence
                    const res = await analyzeWithGemini(base64);
                    
                    const scoreMap = { A: 4, B: 3, C: 2, D: 1, E: 0 };
                    const avg = res.items.reduce((acc, i) => acc + (scoreMap[i.score] || 2), 0) / (res.items.length || 1);
                    const global = avg >= 3.5 ? 'A' : avg >= 2.5 ? 'B' : avg >= 1.5 ? 'C' : avg >= 0.5 ? 'D' : 'E';

                    const result = { ...res, id: Date.now(), global, date: new Date().toLocaleDateString('fr-FR') };
                    setData(result);
                    const newHist = [result, ...history].slice(0, 10);
                    setHistory(newHist);
                    localStorage.setItem('tm_v5_history', JSON.stringify(newHist));
                    setView('result');
                } catch (err) {
                    console.error(err);
                    alert("Erreur de lecture. Essayez une photo plus nette.");
                } finally { setLoading(false); }
            };

            const totals = useMemo(() => {
                if (!data) return { p: 0, c: 0, l: 0 };
                return data.items.reduce((acc, curr) => ({
                    p: acc.p + (curr.p || 0),
                    c: acc.c + (curr.c || 0),
                    l: acc.l + (curr.l || 0)
                }), { p: 0, c: 0, l: 0 });
            }, [data]);

            if (loading) return html`
                <div class="min-h-screen flex flex-col items-center justify-center p-10 bg-slate-900 text-white animate-pop">
                    <div class="relative w-24 h-24 mb-10">
                        <div class="absolute inset-0 border-4 border-white/10 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-emerald-500 rounded-full border-t-transparent animate-spin"></div>
                    </div>
                    <h2 class="text-3xl font-black tracking-tighter">${status}</h2>
                    <p class="text-slate-400 mt-2 font-medium">Extraction des produits alimentaires...</p>
                </div>
            `;

            return html`
                <div class="max-w-md mx-auto min-h-screen p-6 pb-32">
                    ${view === 'home' ? html`
                        <div class="space-y-12 py-10 animate-pop">
                            <header class="text-center space-y-2">
                                <h1 class="text-6xl font-black tracking-tighter text-slate-900 leading-none">Ticket<br/><span class="text-emerald-500">Miam</span></h1>
                                <p class="text-slate-400 font-bold uppercase text-[10px] tracking-widest">Analyse Nutritionnelle IA</p>
                            </header>

                            <label class="flex flex-col items-center justify-center w-full h-80 border-4 border-emerald-500 border-dashed rounded-[3.5rem] bg-white shadow-2xl cursor-pointer hover:bg-emerald-50 transition-all active:scale-95">
                                <div class="w-20 h-20 bg-emerald-500 text-white rounded-full flex items-center justify-center shadow-lg mb-4">
                                    <i class="fas fa-camera text-3xl"></i>
                                </div>
                                <span class="font-black text-slate-800 text-xl">Scanner un ticket</span>
                                <input type="file" class="hidden" accept="image/*" capture="environment" onchange=${onUpload} />
                            </label>

                            ${history.length > 0 && html`
                                <div class="space-y-4">
                                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest px-2">Derniers Scans</h3>
                                    <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden divide-y divide-slate-50">
                                        ${history.map(h => html`
                                            <div key=${h.id} onclick=${() => { setData(h); setView('result'); }} class="flex items-center justify-between p-5 hover:bg-slate-50 cursor-pointer">
                                                <div class="flex items-center space-x-4">
                                                    <${Badge} score=${h.global} size="sm" />
                                                    <div class="flex flex-col">
                                                        <span class="font-bold text-slate-800 text-sm truncate w-40">${h.store}</span>
                                                        <span class="text-[10px] text-slate-300 font-bold">${h.date}</span>
                                                    </div>
                                                </div>
                                                <i class="fas fa-chevron-right text-slate-200"></i>
                                            </div>
                                        `)}
                                    </div>
                                </div>
                            `}
                        </div>
                    ` : html`
                        <div class="space-y-6 animate-pop">
                            <button onclick=${() => setView('home')} class="w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center text-slate-400 active:scale-90 transition-all"><i class="fas fa-arrow-left"></i></button>
                            
                            <section class="bg-white rounded-[3rem] p-10 shadow-2xl text-center space-y-6 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-emerald-400 to-emerald-600"></div>
                                <p class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Bilan du Panier</p>
                                <div class="flex justify-center scale-150 py-4"><${Badge} score=${data.global} size="lg" /></div>
                                <h2 class="text-2xl font-black text-slate-900 leading-tight">${data.store}</h2>
                            </section>

                            <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100">
                                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Profil Nutritionnel Moyen</h3>
                                <div class="flex justify-around text-center">
                                    <div><p class="text-emerald-500 font-black text-xl">${Math.round(totals.p)}g</p><p class="text-[9px] uppercase font-bold text-slate-400">Prot</p></div>
                                    <div><p class="text-blue-500 font-black text-xl">${Math.round(totals.c)}g</p><p class="text-[9px] uppercase font-bold text-slate-400">Gluc</p></div>
                                    <div><p class="text-amber-500 font-black text-xl">${Math.round(totals.l)}g</p><p class="text-[9px] uppercase font-bold text-slate-400">Lip</p></div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <h3 class="text-xs font-black text-slate-800 uppercase tracking-widest px-4">Détail des Articles</h3>
                                ${data.items.map((item, i) => html`
                                    <div key=${i} class="bg-white p-4 rounded-3xl flex items-center space-x-4 border border-slate-100 shadow-sm">
                                        <${Badge} score=${item.score} size="sm" />
                                        <div class="flex-1 min-w-0">
                                            <p class="font-bold text-slate-800 text-sm truncate uppercase">${item.name}</p>
                                            <div class="flex items-center space-x-2 mt-1">
                                                <span class="text-[9px] text-slate-400 font-black">${item.kcal} kcal/100g</span>
                                                ${item.nova4 && html`<span class="bg-indigo-50 text-indigo-500 text-[8px] px-2 py-0.5 rounded-full font-black">ULTRA-TRANSFORMÉ</span>`}
                                            </div>
                                        </div>
                                    </div>
                                `)}
                            </div>
                        </div>
                    `}

                    <nav class="fixed bottom-8 left-10 right-10 glass px-10 py-5 flex justify-around items-center rounded-full shadow-2xl z-50">
                        <button onclick=${() => setView('home')} class="text-2xl ${view === 'home' ? 'text-emerald-500' : 'text-slate-300'}"><i class="fas fa-home"></i></button>
                        <label class="bg-emerald-500 w-16 h-16 rounded-full flex items-center justify-center text-white shadow-xl cursor-pointer transform -translate-y-10 active:scale-90 transition-all border-4 border-slate-50">
                            <i class="fas fa-plus text-2xl"></i>
                            <input type="file" class="hidden" accept="image/*" capture="environment" onchange=${onUpload} />
                        </label>
                        <button onclick=${() => { localStorage.clear(); location.reload(); }} class="text-2xl text-slate-300"><i class="fas fa-trash"></i></button>
                    </nav>
                </div>
            `;
        };

        render(html`<${App} />`, document.getElementById('root'));
    </script>
</body>
</html>
