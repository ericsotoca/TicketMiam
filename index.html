
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicketMiam - Analyse Nutritionnelle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; margin: 0; }
        .nutri-a { background-color: #008b4c; } .nutri-b { background-color: #80c11e; }
        .nutri-c { background-color: #fecb02; } .nutri-d { background-color: #ee8100; }
        .nutri-e { background-color: #e63e11; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        .custom-shadow { box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.1); }
        #root:empty::before {
            content: "TicketMiam...";
            display: flex; justify-content: center; align-items: center; height: 100vh;
            color: #10b981; font-weight: 900; font-size: 1.5rem;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.41.0",
    "react": "https://esm.sh/react@^19.2.4",
    "recharts": "https://esm.sh/recharts@^3.7.0",
    "react/": "https://esm.sh/react@^19.2.4/",
    "tesseract.js": "https://esm.sh/tesseract.js@^7.0.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React from 'https://esm.sh/react@19.0.0';
        import ReactDOM from 'https://esm.sh/react-dom@19.0.0/client';
        import htm from 'https://esm.sh/htm@3.1.1';
        import { GoogleGenAI, Type } from 'https://esm.sh/@google/genai@1.41.0';
        import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'https://esm.sh/recharts@2.15.0';

        const html = htm.bind(React.createElement);
        window.process = { env: { API_KEY: "" } };

        // --- SERVICES ---
        const SCHEMA = {
            type: Type.OBJECT,
            properties: {
                store: { type: Type.STRING },
                items: {
                    type: Type.ARRAY,
                    items: {
                        type: Type.OBJECT,
                        properties: {
                            name: { type: Type.STRING },
                            score: { type: Type.STRING },
                            nova4: { type: Type.BOOLEAN },
                            kcal: { type: Type.NUMBER },
                            p: { type: Type.NUMBER },
                            c: { type: Type.NUMBER },
                            l: { type: Type.NUMBER }
                        },
                        required: ["name", "score", "nova4", "kcal", "p", "c", "l"]
                    }
                }
            },
            required: ["store", "items"]
        };

        async function scanTicket(base64) {
            const ai = new GoogleGenAI({ apiKey: window.process.env.API_KEY });
            const prompt = "Analyse ce ticket de caisse. Liste les produits alimentaires avec estimation Nutri-Score (A-E), NOVA 4 (booléen) et macros (protéines p, glucides c, lipides l) pour 100g. Réponds en JSON.";
            const response = await ai.models.generateContent({
                model: "gemini-3-flash-preview",
                contents: { parts: [{ inlineData: { mimeType: "image/jpeg", data: base64.split(",")[1] } }, { text: prompt }] },
                config: { responseMimeType: "application/json", responseSchema: SCHEMA }
            });
            return JSON.parse(response.text);
        }

        // --- COMPONENTS ---
        const Badge = ({ score, size = 'md' }) => {
            const colors = { A: 'nutri-a', B: 'nutri-b', C: 'nutri-c', D: 'nutri-d', E: 'nutri-e' };
            const sizes = { sm: 'w-6 h-6 text-[10px]', md: 'w-10 h-10 text-lg', lg: 'w-16 h-16 text-3xl' };
            return html`<div className="${colors[score] || 'bg-slate-200'} text-white ${sizes[size]} rounded-lg flex items-center justify-center font-black shadow-sm">${score}</div>`;
        };

        const Chart = ({ p, c, l }) => {
            const data = [
                { name: 'Prot', value: p, color: '#10b981' },
                { name: 'Gluc', value: c, color: '#3b82f6' },
                { name: 'Lip', value: l, color: '#f59e0b' }
            ];
            return html`
                <div className="h-48 w-full">
                    <${ResponsiveContainer} width="100%" height="100%">
                        <${PieChart}>
                            <${Pie} data=${data} cx="50%" cy="50%" innerRadius=${40} outerRadius=${60} paddingAngle=${5} dataKey="value" stroke="none">
                                ${data.map((entry, i) => html`<${Cell} key=${i} fill=${entry.color} />`)}
                            <//>
                            <${Tooltip} />
                            <${Legend} />
                        <//>
                    <//>
                </div>
            `;
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = React.useState('home');
            const [loading, setLoading] = React.useState(false);
            const [data, setData] = React.useState(null);
            const [history, setHistory] = React.useState([]);

            React.useEffect(() => {
                const saved = localStorage.getItem('miam_history');
                if (saved) setHistory(JSON.parse(saved));
            }, []);

            const onFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoading(true); setView('scan');
                try {
                    const reader = new FileReader();
                    const base64 = await new Promise(r => { reader.onload = () => r(reader.result); reader.readAsDataURL(file); });
                    const res = await scanTicket(base64);
                    
                    const scoreValues = { A: 4, B: 3, C: 2, D: 1, E: 0 };
                    const avg = res.items.reduce((acc, i) => acc + (scoreValues[i.score] || 2), 0) / (res.items.length || 1);
                    const globalScore = avg >= 3.5 ? 'A' : avg >= 2.5 ? 'B' : avg >= 1.5 ? 'C' : avg >= 0.5 ? 'D' : 'E';

                    const result = { ...res, id: Date.now(), globalScore, date: new Date().toLocaleDateString() };
                    setData(result);
                    const newHist = [result, ...history].slice(0, 10);
                    setHistory(newHist);
                    localStorage.setItem('miam_history', JSON.stringify(newHist));
                    setView('result');
                } catch (err) {
                    alert("Erreur d'analyse. Réessayez.");
                    setView('home');
                } finally { setLoading(false); }
            };

            return html`
                <div className="max-w-md mx-auto min-h-screen flex flex-col p-6">
                    ${loading ? html`
                        <div className="flex-1 flex flex-col items-center justify-center space-y-6">
                            <div className="w-16 h-16 border-4 border-emerald-500 border-t-transparent animate-spin rounded-full"></div>
                            <h2 className="text-xl font-black text-slate-800">Déchiffrage du ticket...</h2>
                        </div>
                    ` : html`
                        ${view === 'home' && html`
                            <div className="space-y-10 py-10 animate-fadeIn">
                                <header className="text-center">
                                    <h1 className="text-5xl font-black tracking-tighter text-slate-900">TicketMiam</h1>
                                    <p className="text-slate-400 font-medium mt-2">Analysez vos courses en un clin d'œil.</p>
                                </header>
                                <label className="flex flex-col items-center justify-center w-full h-80 border-4 border-emerald-500 border-dashed rounded-[3rem] bg-white custom-shadow cursor-pointer hover:bg-emerald-50 transition-all">
                                    <div className="w-20 h-20 bg-emerald-500 text-white rounded-full flex items-center justify-center shadow-lg mb-4">
                                        <i className="fas fa-camera text-3xl"></i>
                                    </div>
                                    <span className="font-black text-slate-800 text-xl">Scanner un ticket</span>
                                    <input type="file" className="hidden" accept="image/*" capture="environment" onChange=${onFile} />
                                </label>
                                ${history.length > 0 && html`
                                    <div className="space-y-4">
                                        <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">Dernières analyses</h3>
                                        <div className="bg-white rounded-[2rem] border border-slate-100 divide-y divide-slate-50 overflow-hidden shadow-sm">
                                            ${history.map(h => html`
                                                <div key=${h.id} onClick=${() => { setData(h); setView('result'); }} className="flex items-center justify-between p-4 hover:bg-slate-50 cursor-pointer">
                                                    <div className="flex items-center space-x-4">
                                                        <${Badge} score=${h.globalScore} size="sm" />
                                                        <span className="font-bold text-slate-800 text-sm">${h.store}</span>
                                                    </div>
                                                    <span className="text-[10px] font-black text-slate-300 uppercase">${h.date}</span>
                                                </div>
                                            `)}
                                        </div>
                                    </div>
                                `}
                            </div>
                        `}

                        ${view === 'result' && data && html`
                            <div className="space-y-6 animate-fadeIn pb-24">
                                <button onClick=${() => setView('home')} className="w-10 h-10 rounded-full bg-white shadow-md flex items-center justify-center text-slate-500"><i className="fas fa-arrow-left"></i></button>
                                <section className="bg-white rounded-[2.5rem] p-8 shadow-xl text-center space-y-4">
                                    <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Score Global</p>
                                    <div className="flex justify-center scale-125 py-2"><${Badge} score=${data.globalScore} size="lg" /></div>
                                    <h2 className="text-2xl font-black">${data.store}</h2>
                                </section>

                                <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
                                    <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Macronutriments moyens</h3>
                                    <${Chart} 
                                        p=${data.items.reduce((a, b) => a + b.p, 0)} 
                                        c=${data.items.reduce((a, b) => a + b.c, 0)} 
                                        l=${data.items.reduce((a, b) => a + b.l, 0)} 
                                    />
                                </div>

                                <div className="space-y-3">
                                    <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest px-2">Détail du panier</h3>
                                    ${data.items.map((item, i) => html`
                                        <div key=${i} className="bg-white p-4 rounded-2xl flex items-center space-x-4 border border-slate-100 shadow-sm">
                                            <${Badge} score=${item.score} size="sm" />
                                            <div className="flex-1">
                                                <p className="font-bold text-slate-800 text-sm leading-tight">${item.name}</p>
                                                <div className="flex items-center space-x-2 mt-1">
                                                    <span className="text-[9px] text-slate-400 font-black uppercase">${item.kcal} kcal/100g</span>
                                                    ${item.nova4 && html`<span className="bg-red-50 text-red-500 text-[8px] px-1.5 py-0.5 rounded font-black uppercase">Ultra-T</span>`}
                                                </div>
                                            </div>
                                        </div>
                                    `)}
                                </div>
                            </div>
                        `}
                    `}

                    <nav className="fixed bottom-6 left-10 right-10 bg-white/90 backdrop-blur-xl border border-white/20 px-8 py-4 flex justify-around items-center rounded-full shadow-lg z-50">
                        <button onClick=${() => setView('home')} className="text-2xl text-emerald-500"><i className="fas fa-home"></i></button>
                        <label className="bg-emerald-500 w-14 h-14 rounded-full flex items-center justify-center text-white shadow-lg cursor-pointer transform -translate-y-4 hover:scale-110 transition-all">
                            <i className="fas fa-plus text-xl"></i>
                            <input type="file" className="hidden" accept="image/*" capture="environment" onChange=${onFile} />
                        </label>
                        <button onClick=${() => { localStorage.clear(); setHistory([]); setView('home'); }} className="text-2xl text-slate-300"><i className="fas fa-trash"></i></button>
                    </nav>
                </div>
            `;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(html`<${App} />`);
    </script>
</body>
</html>
